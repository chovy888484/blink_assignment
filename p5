let port;
let writer, reader;
let brightness = 0; 
let modeText = "N/A"; 

let redSlider, yellowSlider, greenSlider; 
let redState = 0, yellowState = 0, greenState = 0;

function setup() {
  createCanvas(500, 400);
  background(220);

  // ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²° ë²„íŠ¼
  let connectButton = createButton("Connect to Arduino");
  connectButton.position(10, 10);
  connectButton.mousePressed(connectToArduino);

  // ìŠ¬ë¼ì´ë” (Red, Yellow, Green ì‹ í˜¸ ê¸¸ì´ ì¡°ì •)
  redSlider = createSlider(100, 5000, 2000, 100);
  redSlider.position(30, 50);
  yellowSlider = createSlider(100, 5000, 500, 100);
  yellowSlider.position(30, 80);
  greenSlider = createSlider(100, 5000, 2000, 100);
  greenSlider.position(30, 110);
  
  redSlider.input(sendData);
  yellowSlider.input(sendData);
  greenSlider.input(sendData);
}

function draw() {
  background(220);
  textSize(16);
  
  fill(0);
  text("ğŸš¦ ì‹ í˜¸ë“± ì„¤ì •", 10, 40);
  
  // ìŠ¬ë¼ì´ë” í…ìŠ¤íŠ¸ ì •ë ¬
  textAlign(LEFT, CENTER);
  text("ğŸ”´ ë¹¨ê°• ì‹œê°„: " + redSlider.value() + " ms", 250, 55);
  text("ğŸŸ¡ ë…¸ë‘ ì‹œê°„: " + yellowSlider.value() + " ms", 250, 85);
  text("ğŸŸ¢ ì´ˆë¡ ì‹œê°„: " + greenSlider.value() + " ms", 250, 115);
  
  // ì‹ í˜¸ë“± ê·¸ë˜í”½
  drawTrafficLight();

  // ëª¨ë“œ ë° ë°ê¸° ì¸ë””ì¼€ì´í„°
  drawModeIndicator();
  drawBrightnessIndicator();
}

// ğŸ›‘ ì‹ í˜¸ë“± ê·¸ë˜í”½ ê·¸ë¦¬ê¸°
function drawTrafficLight() {
  let size = 50;  
  let spacing = 70; 
  let xOffset = 170;
  let yOffset = 220;

  fill(redState ? 'red' : 'gray');
  ellipse(xOffset, yOffset, size, size);

  fill(yellowState ? 'yellow' : 'gray');
  ellipse(xOffset + spacing, yOffset, size, size);

  fill(greenState ? 'green' : 'gray');
  ellipse(xOffset + spacing * 2, yOffset, size, size);
}

// ğŸ¨ í˜„ì¬ ëª¨ë“œ ì¸ë””ì¼€ì´í„°
function drawModeIndicator() {
  let xOffset = 30;
  let yOffset = 300;
  let width = 140;
  let height = 30;

  // ëª¨ë“œì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
  let modeColor;
  if (modeText === "Emergency Mode") modeColor = "red";
  else if (modeText === "Blinking Mode") modeColor = "yellow";
  else if (modeText === "Normal Mode") modeColor = "green";
  else {
    modeColor = "gray";
    modeText = "OFF";
  }

  fill(modeColor);
  rect(xOffset, yOffset, width, height, 10);
  
  fill(0);
  textAlign(CENTER, CENTER);
  text(modeText, xOffset + width / 2, yOffset + height / 2);
}

// ğŸ¨ ë°ê¸° ì¸ë””ì¼€ì´í„° (ìˆ«ìë¡œ í‘œì‹œ)
function drawBrightnessIndicator() {
  textAlign(LEFT, CENTER);
  fill(0);
  text("ğŸ“¢ í˜„ì¬ ëª¨ë“œ:", 30, 280);
  text("ğŸ’¡ í˜„ì¬ ë°ê¸°: " + brightness, 30, 340);
}

// ğŸ”Œ ì•„ë‘ì´ë…¸ ì—°ê²° (ì›¹ ì‹œë¦¬ì–¼ API ì‚¬ìš©)
async function connectToArduino() {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });

    writer = port.writable.getWriter();
    readData();

    console.log("âœ… Connected to Arduino!");
  } catch (err) {
    console.error("âŒ Connection failed:", err);
  }
}

// ğŸ“¥ ì‹œë¦¬ì–¼ ë°ì´í„° ì½ê¸° (ìˆ˜ì •ëœ ë²„ì „)
async function readData() {
  const textDecoder = new TextDecoderStream();
  const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
  const reader = textDecoder.readable.getReader();

  try {
    let dataBuffer = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) {
        console.log("âŒ Reader stopped.");
        break;
      }
      if (value) {
        dataBuffer += value;
        let lines = dataBuffer.split("\n");

        while (lines.length > 1) {
          let completeLine = lines.shift().trim();
          console.log("ğŸ“© Received:", completeLine);

          let parts = completeLine.split(",");
          if (parts.length === 7) {
            let isEmergency = parts[0] === "1";
            let isBlinking = parts[1] === "1";
            let isCycleRunning = parts[2] === "1"; // ğŸ”¥ ê¸°ë³¸ ë™ì‘ í™œì„±í™” ì—¬ë¶€ ì¶”ê°€

            redState = parseInt(parts[3]);
            yellowState = parseInt(parts[4]);
            greenState = parseInt(parts[5]);
            brightness = parseInt(parts[6]);

            // ğŸ”¥ OFF ëª¨ë“œ ì¸ë””ì¼€ì´í„° ë°˜ì˜
            if (!isCycleRunning && !isEmergency && !isBlinking) {
              modeText = "OFF";
            } else if (isEmergency) {
              modeText = "Emergency Mode";
            } else if (isBlinking) {
              modeText = "Blinking Mode";
            } else {
              modeText = "Normal Mode";
            }
          }
        }
        dataBuffer = lines[0];
      }
    }
  } catch (err) {
    console.error("âŒ Read error:", err);
  } finally {
    reader.releaseLock();
  }
}


// ğŸ“¤ ì‹œë¦¬ì–¼ ë°ì´í„° ì „ì†¡ (ì‹ í˜¸ ì‹œê°„ ì¡°ì •)
async function sendData() {
  if (port && writer) {
    let data = `${redSlider.value()},${yellowSlider.value()},${greenSlider.value()}\n`;
    const dataArray = new TextEncoder().encode(data);
    await writer.write(dataArray);
    console.log("ğŸ“¤ Sent to Arduino:", data);
  } else {
    console.log("âš ï¸ Serial connection not established.");
  }
}
